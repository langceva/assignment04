---
title: "Assignment 4"
author: Gabriella Cova & Eva Langbehn
format: html
editor: visual
execute: 
  warning: false
  message: false
  echo: false
---

## Loading the data

The analysis for this assignment was done utilizing data from the World Bank Enterprise Survey, found [here](https://www.enterprisesurveys.org/en/data).

```{r}
library(tidyverse)
library(haven)
data <- read_dta("data/New_Comprehensive_September_22_2025.dta")
```

## Visualization #1: Gender Distribution of Top Managers

```{r}
manager_data <- data |>
  filter(!is.na(b7a)) |>
  mutate(manager_gender = if_else(b7a == 1, "Female", "Male")) |>
  count(manager_gender) |>
  mutate(
    percentage = n / sum(n) * 100,
    label = paste0(round(percentage, 1), "%")
  )

ggplot(manager_data, aes(x = "", y = n, fill = manager_gender)) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  geom_text(aes(label = label), 
            position = position_stack(vjust = 0.5),
            size = 5, color = "white", fontface = "bold") +
  labs(
    title = "Gender Distribution of Top Managers",
    subtitle = "Percentage of firms where the head is female vs. male",
    caption = "Source: World Bank Enterprise Survey",
    fill = "Manager Gender"
  ) +
  scale_fill_manual(values = c("Female" = "darkgreen", "Male" = "steelblue")) +
  theme_void() 
```

The below graphs are created utilizing the World Bank Enterprise Survey. We were particularly interested in looking at some of the barriers firms face, especially as it relates to gender and region. This first visualization illustrates the gender gap in female leadership across all of the countries in the WBES, with male managers occupying approximately 84% of top management positions compared to just 16% for female managers. This disparity has critical implications for structual barriers that can disproportionately affect women's career advancement.

## Visualization #2: Access to Finance as a Business Obstacle


```{r}
obstacle_data <- data |>
  filter(!is.na(k30) & k30 >= 0) |>
  mutate(
    obstacle_level = case_when(
      k30 == 0 ~ "No obstacle",
      k30 == 1 ~ "Minor obstacle",
      k30 == 2 ~ "Moderate obstacle",
      k30 == 3 ~ "Major obstacle",
      k30 == 4 ~ "Very severe obstacle"
    ),
    obstacle_level = factor(obstacle_level, 
                           levels = c("No obstacle", "Minor obstacle", 
                                     "Moderate obstacle", "Major obstacle", 
                                     "Very severe obstacle"))
  ) |>
  filter(!is.na(obstacle_level)) |>
  count(obstacle_level) |>
  mutate(percentage = (n / sum(n)) * 100)

# Bar chart
ggplot(obstacle_data, aes(x = obstacle_level, y = percentage, fill = obstacle_level)) +
  geom_col() +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), 
            vjust = -0.5, size = 3.5) +
  labs(
    title = "Access to Finance as a Business Obstacle",
    subtitle = "Distribution across all firms",
    x = "Obstacle Level",
    y = "Percentage of Firms (%)",
    caption = "Source: World Bank Enterprise Survey"
  ) +
  theme_minimal() +
  scale_y_continuous(limits = c(0, 45)) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Blues")

```

This second visualization displays how firms across the survey rate access to finance as an obstacle to their operations, with responses distributed across 5 categories. The data shows that over 40% of firms report facing moderate to very severe obstacles, highlighting that access to finance remains a significant constraint for a substantial portion of businesses. This has policy implications in terms of expanding credit availability and exploring alternative lending mechanisms to foster firm growth and economic development.

## Visualization  #3: Do Older Firms Have More Employees in Latin America?

```{r}
# Firm age vs. number of employees in Latin America
data |>
  filter(region == 2, b6 >= 0, b6 <= 100, l1 >= 5, l1 <= 500) |>
  mutate(b6 = as.numeric(b6), l1 = as.numeric(l1)) |>  
  ggplot(aes(x = b6, y = l1)) +  
  geom_point(alpha = 0.4, color = "steelblue") +  
  geom_smooth(method = "lm", color = "red") +
  annotate("text", x = 75, y = 450, 
           label = "Weak positive correlation", 
           color = "red", size = 4, fontface = "bold") +  # We added this line (for the Part 4: GitHub pages and plot annotation)
  labs(
    title = "Do Older Firms Have More Employees?",
    subtitle = "Firm age vs firm size in Latin America",
    caption = "Source: World Bank Enterprise Survey",
    x = "Firm Age (years)",
    y = "Number of Employees") +
  theme_minimal()

#Comments: 
#b6 = years the firm has been operating
#l1 = total number of full-time employees
#Each dot = one firm
#Filtered -->  ages 0-100 years and employee 5-500.  
#We mutate beacuse is original in stata format. 
```

This graph shows the relationship between firm age and number of employees in Latin America (ages between 0-100 years and employee counts from 5-500 workers). The upward red trend shows that as firms have more years, they tend to hire more workers. However, the trend is moderately weak. There is a clear concentration of firms that are new and have a small number of employees, suggesting the prevalence of small and medium enterprises in Latin America. To conclude, firm age is not the best predictor of number of employees. Additionally, something relevant to take into account is that Latin America is a region with diverse access to finance and macroeconomic conditions that could also add to the wide spread we are seeing.

## Visualization #4: Does corruption hurt sales in Latin America?

```{r}

# Does corruption hurt sales in Latin America?
data |>
  filter(region == 2, j30c >= 0, j30c <= 4, d2 > 0, d2 < 1e9) |>
  ggplot(aes(x = factor(j30c), y = d2, fill = factor(j30c))) +
  geom_boxplot() +
  scale_y_log10(labels = scales::comma) +
  labs(
    title = "Does Corruption Hurt Sales in Latin America?",
    subtitle = "Annual sales by severity of bribery problems faced by firms",
    caption = "Source: World Bank Enterprise Survey",
    x = "Bribery Problem (0=None, 4=Very Severe)",
    y = "Annual Sales"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

#Comments: 
#j30c = severity of bribery/corruption problems (0=None, 4=Very Severe)
# d2 = total annual sales (in local currency)
# Each boxplot = distribution of sales for firms at each corruption level
# Filtered --> Only Latin America, valid corruption ratings (0-4), positive sales under 1 billion
#we use fill = factor(j30c) to make 5 separate boxes. 
# we scale it to a --> Logarithmic Scale (due to variation) and then add the commas to understand it better.

```

This graph shows if bribery problems affect annual sales. This graph only refers to Latin America, valid corruption ratings (0-4), and positive sales under 1 billion. The similarity of annual sales with bribery problems suggests that bribery doesn't directly affect sales. However, we are comparing a lot of different firms that have different sizes and that a bribery problem might look different. Additionally, this is a self-reported variable that might have its own problems. Third, some firms may successfully navigate corrupt environments by paying bribes and that's why their sales might not get affected.
